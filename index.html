<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title> Entrenamientos v.2. </title>

<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
<meta name="format-detection" content="telephone=no">

<link rel="manifest" href="./manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="RV FIT">

<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">

<!-- iOS PWA Splash (iPhone 16 Pro) -->
<link rel="apple-touch-startup-image"
      href="./splash-iphone16pro-portrait-1206x2622.png"
      media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
<link rel="apple-touch-startup-image"
      href="./splash-iphone16pro-landscape-2622x1206.png"
      media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">

<style>
:root{
  --primary:#2563eb;
  --primary2:#60a5fa;
  --scheduled:#fde68a;
  --done:#22c55e;
  --border:#cbd5e1;
  --bg:#f8fafc;
  --weekend:#e5e7eb;
}

/* Feel de app iOS */
html, body{
  height:100%;
  background:var(--bg);
}
*{
  -webkit-touch-callout:none;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);

  /* Safe areas iOS */
  padding-top: calc(1rem + env(safe-area-inset-top));
  padding-right: calc(1rem + env(safe-area-inset-right));
  padding-bottom: calc(1rem + env(safe-area-inset-bottom));
  padding-left: calc(1rem + env(safe-area-inset-left));

  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;

  overscroll-behavior-y: none;
}

/* ===== Splash overlay (web) ===== */
#splash{
  position:fixed;
  inset:0;
  background:var(--bg);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  opacity:1;
  transition:opacity .45s ease;

  padding-top: env(safe-area-inset-top);
  padding-right: env(safe-area-inset-right);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
}
#splash.hide{
  opacity:0;
  pointer-events:none;
}
#splash img{
  width:160px;
  height:160px;
  border-radius:28px;
  box-shadow:0 18px 40px rgba(0,0,0,.18);
}
#splash .splash-title{
  font: 600 12px system-ui,-apple-system,sans-serif;
  color:#475569;
  letter-spacing:.2px;
}
/* ===== Fin splash overlay ===== */

.container{
  max-width:420px;
  margin:auto;
  background:white;
  padding:1rem;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}

h1{text-align:center;margin:.2rem 0 .6rem;font-size:1.1rem;}

button{
  padding:.35rem .55rem;
  border-radius:8px;
  border:1px solid var(--border);
  background:white;
  font-size:.75rem;
  cursor:pointer;
}
button.active{
  background:var(--primary);
  color:white;
  border-color:var(--primary);
}

.nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}
#label{
  display:inline-block;
  padding:.25rem .6rem;
  border-radius:999px;
  background:linear-gradient(135deg, rgba(37,99,235,.12), rgba(96,165,250,.18));
  border:1px solid rgba(37,99,235,.18);
  color:var(--primary);
  font-weight:800;
  font-size:.85rem;
}

.center{display:flex;justify-content:center;margin:.5rem 0;}

.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
}
.calendar.past{
  background:repeating-linear-gradient(
    45deg,
    rgba(0,0,0,.03),
    rgba(0,0,0,.03) 4px,
    transparent 4px,
    transparent 8px
  );
  padding:4px;
  border-radius:12px;
}
.day-name{text-align:center;font-size:.7rem;font-weight:600;}
.day{
  height:64px;
  border:1px solid var(--border);
  border-radius:10px;
  text-align:center;
  position:relative;
  cursor:pointer;
  background:white;
  user-select:none;
  -webkit-user-select:none;
  touch-action: manipulation;
}
.day.weekend{background:var(--weekend);}
.day.selected{border:2px solid var(--primary);}
.day.scheduled{background:var(--scheduled);}
.day.done{background:var(--done);color:white;}
.day.done::after{
  content:"‚úî";
  position:absolute;
  top:4px;
  right:6px;
}
.num{margin-top:6px;font-weight:700;}
.time{font-size:.65rem;}
.empty{visibility:hidden;}

/* QUICK PROGRAM */
.quick-toggle{display:flex;justify-content:center;margin:.4rem 0;}
.quick-panel{
  display:none;
  border:1px solid var(--border);
  border-radius:12px;
  padding:.6rem;
  font-size:.7rem;
}
.quick-panel.show{display:block;}
.quick-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:.5rem;
}
.quick-row strong{width:70px;text-align:right;opacity:.75}

/* WEEK BAR */
.weekbar{
  margin:.55rem 0 .2rem;
  border:1px solid var(--border);
  border-radius:12px;
  padding:.55rem .6rem;
}
.weekbar-head{
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  gap:8px;
  font-size:.75rem;
}
.weekbar-title{
  font-weight:800;
  color:#0f172a;
}
.weekbar-meta{
  color:#334155;
  font-weight:700;
}
.bar{
  height:8px;
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden;
  margin-top:.35rem;
}
.fill{
  height:100%;
  background:var(--primary);
  width:0%;
  transition:width .25s ease;
}

/* CLEAN BAR */
.clean-bar{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  margin:.2rem 0 0;
  font-size:.75rem;
}
.clean-bar button{font-size:.7rem;}
.clean-bar span{
  cursor:pointer;
  font-weight:800;
  color:var(--primary);
}

/* HISTORY (past months) */
.history{
  border:1px solid var(--border);
  border-radius:12px;
  padding:.55rem .6rem;
  margin-top:.6rem;
  font-size:.7rem;
  display:flex;
  justify-content:center;
}
.history-inner{
  display:grid;
  grid-template-columns: 88px 88px auto;
  grid-template-rows: auto auto;
  column-gap:10px;
  row-gap:6px;
  align-items:center;
  justify-items:center;
}
.history-inner .hlabel{
  font-weight:800;
  color:#334155;
  font-size:.68rem;
}
.history-inner input{
  width:72px;
  padding:.28rem .25rem;
  font-size:.72rem;
  text-align:center;
  border:1px solid var(--border);
  border-radius:10px;
}
.history-inner button{
  grid-row: 1 / span 2;
  height:100%;
  padding:.35rem .7rem;
  font-size:.72rem;
}

/* ANUAL */
.annual{
  border-top:1px solid var(--border);
  margin-top:.6rem;
  padding-top:.5rem;
  display:none;
}
.annual.show{display:block;}
.annual-row{display:flex;gap:6px;}
.annual-month{flex:1;font-size:.62rem;text-align:center;}
.annual-bar{
  height:6px;
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden;
  display:flex;
  margin:.18rem 0;
}
.annual-done{background:var(--done);}
.annual-sched{background:var(--scheduled);}

/* Toast */
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  color:white;
  padding:.5rem .9rem;
  border-radius:14px;
  font-size:.75rem;
  opacity:0;
  transition:.3s;
}
.toast.show{opacity:1;}

/* ====== PROGRAMACI√ìN (desplegable) ====== */
.program-group{
  margin-top:.65rem;
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
}
.program-header{
  padding:.6rem;
  font-weight:900;
  background:linear-gradient(135deg, rgba(37,99,235,.08), rgba(96,165,250,.12));
  border-bottom:1px solid rgba(203,213,225,.8);
  cursor:pointer;
  text-align:center;
  color:#0f172a;
  user-select:none;
  -webkit-user-select:none;
}
.program-content{
  display:none;
  padding:.6rem;
  flex-direction:column;
  gap:.6rem;
}
.program-content.show{
  display:flex;
}
.program-line{
  display:flex;
  gap:6px;
  justify-content:center;
  flex-wrap:wrap;
}
</style>
</head>

<body>

<!-- Splash overlay (web) -->
<div id="splash" aria-hidden="true">
  <div style="display:flex; flex-direction:column; align-items:center; gap:14px;">
    <img src="./apple-touch-icon.png" alt="RV FIT">
    <div class="splash-title">RV FIT</div>
  </div>
</div>

<div class="container">

  <h1>Entrenamientos</h1>

  <div class="nav">
    <button onclick="prevMonth()">‚óÄ</button>
    <strong id="label"></strong>
    <button onclick="nextMonth()">‚ñ∂</button>
  </div>

  <div class="center" id="monthNowWrap" style="display:none">
    <button onclick="goToCurrentMonth()">üìç Mes actual</button>
  </div>

  <div class="calendar" id="calendar"></div>

  <!-- ‚úÖ Semana actual justo debajo del calendario (solo mes actual) -->
  <div class="weekbar" id="weekBar" style="display:none">
    <div class="weekbar-head">
      <div class="weekbar-title">Semana actual</div>
      <div class="weekbar-meta" id="weekMeta">0/0</div>
    </div>
    <div class="bar"><div class="fill" id="weekFill"></div></div>
  </div>

  <!-- ‚úÖ Resumen anual justo debajo de la semana actual -->
  <div class="center">
    <button onclick="toggleAnnual()">üìä Resumen anual</button>
  </div>
  <div class="annual" id="annual"></div>

  <!-- ‚úÖ Programaci√≥n (desplegable) ‚Äî visible desde mes actual en adelante -->
  <div class="program-group" id="programGroup" style="display:none">
    <div class="program-header" onclick="toggleProgramGroup()">‚öôÔ∏è Programaci√≥n</div>

    <div class="program-content" id="programContent">
      <!-- 1) Horarios -->
      <div class="program-line" id="programmer">
        <button onclick="setTime('06:30')">06:30</button>
        <button onclick="setTime('07:00')">07:00</button>
        <button onclick="setTime('07:30')">07:30</button>
        <button onclick="setTime('--:--')">--:--</button>
      </div>

      <!-- 2) Programaci√≥n r√°pida -->
      <div class="quick-toggle" id="quickToggle">
        <button onclick="toggleQuick()">‚ö° Programaci√≥n r√°pida</button>
      </div>

      <div class="quick-panel" id="quickPanel">
        <div class="quick-row">
          <strong>D√≠a</strong>
          <button onclick="toggleQuickDay(1)">L</button>
          <button onclick="toggleQuickDay(2)">M</button>
          <button onclick="toggleQuickDay(3)">W</button>
          <button onclick="toggleQuickDay(4)">J</button>
          <button onclick="toggleQuickDay(5)">V</button>
          <button onclick="toggleQuickDay(6)">S</button>
          <button onclick="toggleQuickDay(0)">D</button>
        </div>
        <div class="quick-row">
          <strong>Hora</strong>
          <button onclick="setQuickTime('06:30')">06:30</button>
          <button onclick="setQuickTime('07:00')">07:00</button>
          <button onclick="setQuickTime('07:30')">07:30</button>
          <button onclick="setQuickTime('--:--')">--:--</button>
        </div>
        <div class="center">
          <button onclick="applyQuick()">Programar</button>
        </div>
      </div>

      <!-- 3) Limpieza (solo mes actual) -->
      <div class="clean-bar" id="cleanBar" style="display:none">
        <button id="cw" onclick="selectClean('week')">üßπ Semana</button>
        <button id="cm" onclick="selectClean('month')">üóë Mes</button>
        <button id="ca" onclick="selectClean('all')">üî• Todo</button>
        <span onclick="executeClean()">Borrar</span>
      </div>
    </div>
  </div>

  <!-- Hist√≥rico (solo meses pasados) -->
  <div class="history" id="historyPanel" style="display:none">
    <div class="history-inner">
      <div class="hlabel">Programados</div>
      <div class="hlabel">Reales</div>
      <button onclick="saveHistory()">Guardar</button>

      <input id="hPlan" type="number" inputmode="numeric">
      <input id="hDone" type="number" inputmode="numeric">
      <div></div>
    </div>
  </div>

</div><!-- /container -->

<div class="toast" id="toast"></div>

<script>
/* Splash overlay: ocultar suave */
(function () {
  const splash = document.getElementById('splash');
  if (!splash) return;

  const MIN_MS = 1100;
  const start = Date.now();

  function hideSplash() {
    const elapsed = Date.now() - start;
    const wait = Math.max(0, MIN_MS - elapsed);

    setTimeout(() => {
      requestAnimationFrame(() => {
        splash.classList.add('hide');
        setTimeout(() => splash.remove(), 400);
      });
    }, wait);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', hideSplash, { once: true });
  } else {
    hideSplash();
  }

  setTimeout(hideSplash, 2500);
})();
</script>

<script>
/* Entrenamientos RV */
const STORAGE="rv-data", HST="rv-history";
let data=JSON.parse(localStorage.getItem(STORAGE)||"{}");
let history=JSON.parse(localStorage.getItem(HST)||"{}");

let current=new Date(), selected=null;
let quickDays=new Set(), quickTime=null;
let cleanMode=null;

// long tap state
let pressTimer=null;
let pressedKey=null;
const LONG_PRESS_MS=600;

const cal=document.getElementById("calendar");
const label=document.getElementById("label");
const toast=document.getElementById("toast");
const quickPanel=document.getElementById("quickPanel");
const historyPanel=document.getElementById("historyPanel");
const quickToggle=document.getElementById("quickToggle");
const programmer=document.getElementById("programmer");
const cleanBar=document.getElementById("cleanBar");
const annual=document.getElementById("annual");
const monthNowWrap=document.getElementById("monthNowWrap");
const weekBar=document.getElementById("weekBar");
const weekMeta=document.getElementById("weekMeta");
const weekFill=document.getElementById("weekFill");
const programGroup=document.getElementById("programGroup");
const programContent=document.getElementById("programContent");

const dayNames=["L","M","M","J","V","S","D"];
const monthNames=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
const monthsShort=["E","F","M","A","M","J","J","A","S","O","N","D"];

function save(){
  localStorage.setItem(STORAGE,JSON.stringify(data));
  localStorage.setItem(HST,JSON.stringify(history));
}
function showToast(t){
  toast.textContent=t;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),1500);
}

function isPastMonth(){
  const n=new Date();
  return current.getFullYear()<n.getFullYear() ||
    (current.getFullYear()===n.getFullYear() && current.getMonth()<n.getMonth());
}
function isCurrentMonthView(){
  const n=new Date();
  return current.getFullYear()===n.getFullYear() && current.getMonth()===n.getMonth();
}
function isFutureOrCurrentMonth(){
  return !isPastMonth();
}

function keyToDate(key){
  const [yy,mm,dd]=key.split("-").map(Number);
  const dt=new Date(yy,mm,dd);
  dt.setHours(0,0,0,0);
  return dt;
}

/* ===== Programaci√≥n desplegable ===== */
function toggleProgramGroup(){
  programContent.classList.toggle("show");
}

/* ========== RENDER ========== */
function render(){
  cal.innerHTML="";
  dayNames.forEach(d=>cal.innerHTML+=`<div class="day-name">${d}</div>`);

  const y=current.getFullYear(), m=current.getMonth();
  label.textContent=`${monthNames[m]} ${y}`;

  const past=isPastMonth();
  const isCurrent=isCurrentMonthView();

  // UI visibility rules
  cal.classList.toggle("past",past);

  // Semana actual: solo mes actual
  weekBar.style.display = (!past && isCurrent) ? "block" : "none";

  // Hist√≥rico: solo meses pasados
  historyPanel.style.display = past ? "flex" : "none";

  // Bot√≥n "Mes actual"
  monthNowWrap.style.display = isCurrent ? "none" : "flex";

  // Programaci√≥n: mes actual y futuros (no pasado)
  programGroup.style.display = past ? "none" : "block";

  // Limpieza: solo mes actual
  cleanBar.style.display = (!past && isCurrent) ? "flex" : "none";

  // cerrar panel r√°pido al cambiar mes
  quickPanel.classList.remove("show");

  // fill history inputs if present
  if(past){
    const hk = `${y}-${m}`;
    const h = history[hk] || {plan:"", done:""};
    document.getElementById("hPlan").value = (h.plan ?? "");
    document.getElementById("hDone").value = (h.done ?? "");
  }

  // calendar build
  const first=(new Date(y,m,1).getDay()||7);
  const total=(new Date(y,m+1,0).getDate());
  const today=new Date(); today.setHours(0,0,0,0);

  for(let i=1;i<first;i++) cal.innerHTML+='<div class="empty"></div>';

  for(let d=1; d<=total; d++){
    const date=new Date(y,m,d); date.setHours(0,0,0,0);
    const key=`${y}-${m}-${d}`;

    const cell=document.createElement("div");
    cell.className="day";
    if(date.getDay()===0||date.getDay()===6) cell.classList.add("weekend");
    if(key===selected) cell.classList.add("selected");
    if(data[key]) cell.classList.add(data[key].done ? "done" : "scheduled");

    cell.innerHTML=`<div class="num">${d}</div><div class="time">${data[key]?.time||""}</div>`;

    // click (desktop): toggle done if scheduled and date <= today and not past month view
    cell.addEventListener("click", ()=>{
      selected=key;
      if(!past && data[key] && date<=today){
        data[key].done = !data[key].done;
        save();
      }
      render();
    });

    // long press delete (iOS compatible)
    let longPressTriggered = false;

    const startPress = (ev) => {
      if (past) return;

      longPressTriggered = false;
      pressedKey = key;
      clearTimeout(pressTimer);

      pressTimer = setTimeout(() => {
        longPressTriggered = true;

        if (pressedKey !== key) return;

        if (data[key]) {
          delete data[key];
          save();
          showToast("D√≠a eliminado");
          if (selected === key) selected = null;
          render();
        } else {
          showToast("Nada que borrar");
        }
      }, LONG_PRESS_MS);
    };

    const endPress = (ev) => {
      clearTimeout(pressTimer);
      pressedKey = null;

      if (longPressTriggered) return;

      // iOS: forzamos tap (a veces no dispara click)
      if (ev && (ev.type === "touchend" || ev.type === "touchcancel")) {
        selected = key;

        if (!past && data[key] && date <= today) {
          data[key].done = !data[key].done;
          save();
        }
        render();
      }
    };

    cell.addEventListener("touchstart", startPress, { passive: false });
    cell.addEventListener("touchend", endPress);
    cell.addEventListener("touchcancel", endPress);
    cell.addEventListener("mousedown", startPress);
    cell.addEventListener("mouseup", endPress);
    cell.addEventListener("mouseleave", endPress);

    cal.appendChild(cell);
  }

  if(!past && isCurrent){
    renderWeekBar();
  }
  renderAnnual();
}

/* ========== PROGRAMACI√ìN MANUAL ========== */
function setTime(t){
  if(isPastMonth()) return;
  if(!selected){ showToast("Selecciona un d√≠a"); return; }
  data[selected]={time:t,done:false};
  save();
  render();
}

/* ========== QUICK ========== */
function toggleQuick(){ if(!isPastMonth()) quickPanel.classList.toggle("show"); }
function toggleQuickDay(d){
  if(isPastMonth()) return;
  if(quickDays.has(d)){ quickDays.delete(d); event.target.classList.remove("active"); }
  else{ quickDays.add(d); event.target.classList.add("active"); }
}
function setQuickTime(t){
  if(isPastMonth()) return;
  quickTime=t;
  const row = event.target.closest(".quick-row");
  row.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}
function applyQuick(){
  if(isPastMonth()) return;
  if(!quickTime){ showToast("Elige una hora"); return; }
  if(!quickDays.size){ showToast("Elige d√≠as"); return; }

  const y=current.getFullYear(), m=current.getMonth();
  for(let d=1; d<=31; d++){
    const dt=new Date(y,m,d);
    if(dt.getMonth()!==m) continue;
    if(quickDays.has(dt.getDay())){
      const k=`${y}-${m}-${d}`;
      if(!data[k]) data[k]={time:quickTime,done:false};
    }
  }
  save();
  showToast("Programaci√≥n aplicada");
  render();
}

/* ========== WEEK BAR ========== */
function startOfWeekMonday(dt){
  const d=new Date(dt); d.setHours(0,0,0,0);
  const day=(d.getDay()+6)%7;
  d.setDate(d.getDate()-day);
  return d;
}
function renderWeekBar(){
  const today=new Date(); today.setHours(0,0,0,0);
  const ws=startOfWeekMonday(today);
  const we=new Date(ws); we.setDate(ws.getDate()+6);

  let planned=0, done=0;
  Object.keys(data).forEach(k=>{
    const dt=keyToDate(k);
    if(dt < ws || dt > we) return;
    if(dt > today) return;
    planned += 1;
    if(data[k].done) done += 1;
  });

  weekMeta.textContent = `${done}/${planned}`;
  const pct = planned ? Math.round((done/planned)*100) : 0;
  weekFill.style.width = pct + "%";
}

/* ========== CLEAN BAR ========== */
function selectClean(m){
  cleanMode=m;
  ["cw","cm","ca"].forEach(id=>document.getElementById(id).classList.remove("active"));
  document.getElementById(m==="week"?"cw":m==="month"?"cm":"ca").classList.add("active");
}
function executeClean(){
  if(isPastMonth()){ return; }
  if(!cleanMode){ showToast("Selecciona qu√© borrar"); return; }

  if(cleanMode==="all"){
    if(!confirm("¬øBorrar todo el calendario?")) return;
    data={};
    save();
    showToast("Todo borrado");
    selected=null;
    render();
    return;
  }

  if(!selected){ showToast("Selecciona un d√≠a"); return; }
  const base=keyToDate(selected);

  if(cleanMode==="week"){
    const ws=startOfWeekMonday(base);
    const we=new Date(ws); we.setDate(ws.getDate()+6);
    Object.keys(data).forEach(k=>{
      const dt=keyToDate(k);
      if(dt>=ws && dt<=we) delete data[k];
    });
    save();
    showToast("Semana borrada");
    selected=null;
    render();
  }

  if(cleanMode==="month"){
    const y=base.getFullYear(), m=base.getMonth();
    Object.keys(data).forEach(k=>{
      const [yy,mm]=k.split("-").map(Number);
      if(yy===y && mm===m) delete data[k];
    });
    save();
    showToast("Mes borrado");
    selected=null;
    render();
  }
}

/* ========== HIST√ìRICO ========== */
function saveHistory(){
  const y=current.getFullYear(), m=current.getMonth();
  const key=`${y}-${m}`;
  const plan = Number(document.getElementById("hPlan").value || 0);
  const done = Number(document.getElementById("hDone").value || 0);
  history[key]={plan, done};
  localStorage.setItem(HST, JSON.stringify(history));
  showToast("Hist√≥rico guardado");
  renderAnnual();
}

/* ========== ANNUAL ========== */
function toggleAnnual(){
  annual.classList.toggle("show");
  renderAnnual();
}
function renderAnnual(){
  if(!annual.classList.contains("show")){
    return;
  }
  annual.innerHTML="";
  const y=current.getFullYear();
  const row=document.createElement("div");
  row.className="annual-row";

  for(let m=0; m<12; m++){
    let plan=0, done=0;

    const hk=`${y}-${m}`;
    if(history[hk]){
      plan = Number(history[hk].plan || 0);
      done = Number(history[hk].done || 0);
    }else{
      Object.keys(data).forEach(k=>{
        const [yy,mm]=k.split("-").map(Number);
        if(yy===y && mm===m){
          plan += 1;
          if(data[k].done) done += 1;
        }
      });
    }

    const pct = plan ? (done/plan) : 0;
    const c=document.createElement("div");
    c.className="annual-month";
    c.innerHTML=`
      <strong>${monthsShort[m]}</strong>
      <div class="annual-bar">
        <div class="annual-done" style="width:${(pct*100).toFixed(1)}%"></div>
        <div class="annual-sched" style="width:${((1-pct)*100).toFixed(1)}%"></div>
      </div>
      ${done}/${plan}
    `;
    row.appendChild(c);
  }

  annual.appendChild(row);
}

/* ========== NAV ========== */
function prevMonth(){ current.setMonth(current.getMonth()-1); selected=null; render(); }
function nextMonth(){ current.setMonth(current.getMonth()+1); selected=null; render(); }
function goToCurrentMonth(){ current=new Date(); selected=null; render(); }

/* init */
render();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./sw.js', { scope: '/rv-fit/' });
      await reg.update();

      if (reg.waiting && navigator.serviceWorker.controller) {
        showUpdateToast(reg.waiting);
      }

      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        if (!newWorker) return;

        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            showUpdateToast(newWorker);
          }
        });
      });

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (window.__reloading) return;
        window.__reloading = true;
        window.location.reload();
      });

    } catch (err) {
      console.error('SW error', err);
    }
  });
}

function showUpdateToast(worker) {
  if (document.getElementById('updateToast')) return;

  const toast = document.createElement("div");
  toast.id = 'updateToast';
  toast.style.position = "fixed";
  toast.style.bottom = "30px";
  toast.style.left = "50%";
  toast.style.transform = "translateX(-50%)";
  toast.style.background = "rgba(15,23,42,.95)";
  toast.style.color = "white";
  toast.style.padding = "12px 14px";
  toast.style.borderRadius = "16px";
  toast.style.fontSize = "13px";
  toast.style.display = "flex";
  toast.style.gap = "12px";
  toast.style.alignItems = "center";
  toast.style.zIndex = "999999";

  toast.innerHTML = `
    Nueva versi√≥n disponible
    <button id="btnUpdate" style="
      background:#2563eb;
      color:white;
      border:none;
      padding:7px 10px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      font-weight:700;
    ">Actualizar</button>
  `;

  document.body.appendChild(toast);

  document.getElementById('btnUpdate').addEventListener('click', () => {
    worker.postMessage("SKIP_WAITING");
  });
}
</script>

</body>
</html>
